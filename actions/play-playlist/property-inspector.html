<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Play Playlist Configuration</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 15px;
      margin: 0;
      background: #1e1e1e;
      color: #ffffff;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .section {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-size: 12px;
      font-weight: 600;
      color: #a0a0a0;
    }
    input, select {
      padding: 8px;
      background: #2d2d2d;
      border: 1px solid #3d3d3d;
      color: #ffffff;
      border-radius: 4px;
      font-size: 12px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #1db954;
    }
    button {
      padding: 10px;
      background: #1db954;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #1ed760;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .info {
      font-size: 11px;
      color: #888;
      margin-top: 5px;
    }
    #playlistList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #3d3d3d;
      border-radius: 4px;
      background: #2d2d2d;
    }
    .playlist-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #3d3d3d;
    }
    .playlist-item:hover {
      background: #3d3d3d;
    }
    .playlist-item.selected {
      background: #1db954;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section">
      <label for="playlistId">Playlist ID or URL</label>
      <input type="text" id="playlistId" placeholder="Enter playlist ID or Spotify URL">
      <div class="info">Example: 37i9dQZF1DXcBWIGoYBM5M or paste full Spotify URL</div>
    </div>

    <div class="section">
      <button id="loadPlaylists">Load My Playlists</button>
      <div id="playlistList"></div>
    </div>

    <div class="section">
      <button id="saveButton">Save</button>
    </div>
  </div>

  <script src="https://developer.elgato.com/documentation/stream-deck-sdk/js-sdk/stream-deck.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    
    let websocket = null;
    let registerEvent = null;
    let accessToken = null;

    function connectElgatoStreamDeckSocket(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
      registerEvent = inRegisterEvent;
      
      websocket = new WebSocket('ws://localhost:' + inPort);

      websocket.onopen = () => {
        const json = {
          event: inRegisterEvent,
          uuid: inUUID
        };
        websocket.send(JSON.stringify(json));
        
        const getSettings = {
          event: 'getSettings',
          context: inUUID
        };
        websocket.send(JSON.stringify(getSettings));
      };

      websocket.onmessage = (evt) => {
        const data = JSON.parse(evt.data);
        
        if (data.event === 'didReceiveSettings') {
          const settings = data.payload.settings;
          if (settings.playlistId) {
            $('playlistId').value = settings.playlistId;
          }
          if (settings.accessToken) {
            accessToken = settings.accessToken;
          }
        } else if (data.event === 'sendToPropertyInspector') {
          // Receive data from plugin
          const payload = data.payload;
          if (payload.accessToken) {
            accessToken = payload.accessToken;
          }
        }
      };
    }

    function extractPlaylistId(input) {
      // Handle full URL: https://open.spotify.com/playlist/37i9dQZF1DXcBWIGoYBM5M
      const urlMatch = input.match(/playlist\/([a-zA-Z0-9]+)/);
      if (urlMatch) {
        return urlMatch[1];
      }
      // Handle just the ID
      if (/^[a-zA-Z0-9]+$/.test(input)) {
        return input;
      }
      return null;
    }

    $('playlistId').addEventListener('input', () => {
      const playlistId = extractPlaylistId($('playlistId').value);
      if (playlistId) {
        saveSettings({ playlistId: playlistId });
      }
    });

    $('loadPlaylists').addEventListener('click', async () => {
      if (!accessToken) {
        alert('Please authorize Spotify first in the main configuration');
        return;
      }

      try {
        const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load playlists');
        }

        const data = await response.json();
        const listDiv = $('playlistList');
        listDiv.innerHTML = '';

        data.items.forEach(playlist => {
          const item = document.createElement('div');
          item.className = 'playlist-item';
          item.textContent = playlist.name;
          item.addEventListener('click', () => {
            document.querySelectorAll('.playlist-item').forEach(el => {
              el.classList.remove('selected');
            });
            item.classList.add('selected');
            $('playlistId').value = playlist.id;
            saveSettings({ playlistId: playlist.id });
          });
          listDiv.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading playlists:', error);
        alert('Failed to load playlists. Make sure you are authorized.');
      }
    });

    $('saveButton').addEventListener('click', () => {
      const playlistId = extractPlaylistId($('playlistId').value);
      if (playlistId) {
        saveSettings({ playlistId: playlistId });
        alert('Settings saved!');
      } else {
        alert('Invalid playlist ID or URL');
      }
    });

    function saveSettings(settings) {
      if (!websocket) return;

      const json = {
        event: 'setSettings',
        context: registerEvent ? registerEvent.split('.').pop() : '',
        payload: {
          settings: settings
        }
      };
      websocket.send(JSON.stringify(json));
    }
  </script>
</body>
</html>
